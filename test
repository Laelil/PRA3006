<!DOCTYPE html>
<html lang="en">
<head>
  <title>Example 4</title>
  <!-- Initialize a global WBK function -->
  <script src="https://cdn.rawgit.com/maxlath/wikidata-sdk/dist/dist/wikibase-sdk.min.js"></script>
  <!-- Initialize a global wdk object using the WBK object -->
  <script src="https://cdn.rawgit.com/maxlath/wikidata-sdk/dist/dist/wikidata-sdk.min.js"></script>
</head>


  <pre id="output"></pre>
  <script>
    
    query = 
SELECT  ?drug ?drugLabel 
        ?drugClass ?drugClassLabel 
        ?roleOfDrug ?roleOfDrugLabel 
        ?otherDiseaseTreated ?otherDiseaseTreatedLabel 
        ?significantDrugDrugInteractions ?significantDrugDrugInteractionsLabel
        ?chemicalStructure ?chemicalStructureLabel
        ?chemicalFormula 
        ?molInteractsWith ?molInteractsWithLabel
        ?involvedInBiologicalProcess ?involvedInBiologicalProcessLabel

WHERE 
{
  wd:Q202387 wdt:P2176 ?drug.                                 # list of all the drugs used to treat PTSD
  ?drug wdt:P279 ?drugClass.                                  # the class to which the drug belongs
  ?drug wdt:P2868 ?roleofDrug.                                # the role of the drug (within the class?)
  ?drug wdt:P2175 ?otherDiseaseTreated.                       # what other disease / conditions the drug can treat
  ?drug wdt:P274 ?chemicalFormula                             # chemical formula

 SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". } 
}
    fetch(
      wdk.sparqlQuery(query)
    ).then( response => response.json()
    ).then( wdk.simplify.sparqlResults
    ).then(
      function (response) {
        document.getElementById('output').innerHTML =
          JSON.stringify(response, undefined, 2);
      }
    )
  </script>
  
 <!-- Bubble Chart 1/2 - Display -->	
<!-- |--- Displays number of diseases treated by drugs -->
<!-- |--- Changes with button press                    -->	
<div class="boxUnit" style="border-width: 10px 10px 10px 10px">
  <span class="boxUnitTitle" style="font-size:4em">&ensp; Which drug treats more diseases? &ensp;</span>
  <!-- #chart receives SVG element of makeBubble() -->
  <div id="chart" style="text-align:center;">
  </div>
</div>

<!-- Bubble Chart 2/2 - Code -->
<script>
	// Bubble Chart Function, adapted from Egon W., 2020 - https://github.com/egonw/pils/tree/master/BubbleChart
	// |--- Accepts name-value pair object array
	// |--- Overwrites previous chart when re-called upon button press
	// |--- Displays bubble for each drug with radius proportional to (value)^2 
	function makeBubble(dataset) {
		// Remove previous chart
		document.getElementById("chart").innerHTML = "";
		
		// Extract data from input, restructure the asynchronous response by creating a map of drug names and disease counts
		data = {};
		data.children = dataset.map(function(item) { return { "Name": item.name , "Count": item.value } });

		var width = 1200;
		var height = 800;

		// Create the main SVG element
		var svg = d3.select('#chart').append('svg')
				  .attr('width', width)
				  .attr('height', height)
				  .attr('transform', 'translate(200,0)');

		var color = d3.scaleOrdinal(d3.schemeCategory20);

		// Create a new structure from the data where each element has coordinates corresponding to the size of the holding SVG
		var bubble = d3.pack(data)
				  .size([height, height])
				  .padding(5);

		var nodes = d3.hierarchy(data)
				  .sum(function(d) { return d.Count*d.Count; });

		// Create the bubbles
		circles = svg.selectAll("g")
				.data(bubble(nodes).descendants())
				.enter()
				.filter(function(d){
				  return  !d.children
				})
				.append("g")
				.attr("transform", function(d) {
				  return "translate(" + d.x + "," + d.y + ")";
				})

		circles.append("circle")
				.attr("r", function(d) {
					  return d.r;
				})
				.style("fill", function(d,i) {
					  return color(i);
				})

		// Add drug text to the bubbles
		circles.append("text")
				.style("text-anchor", "middle")
				.attr("font-family", "sans-serif")
				.attr("font-size", function(d){
					return d.r/5;
				})
				.text(function(d) {
                                        if(d.data.Name === "levofloxacin hemihydrate") {
						return d.data.Name.substring(0, d.r/5);
					} else {
					return d.data.Name.substring(0, d.r/2);
					}
				});

		// Add disease number text to the bubbles
		circles.append("text")
			  .attr("dy", "1.3em")
			  .style("text-anchor", "middle")
			  .text(function(d) {
				  return "Diseases: " + d.data.Count;
			  })
			  .attr("font-family", "sans-serif")
			  .attr("font-size", function(d){
				  return d.r/5;
			  })
	}
</script>

</body>
</html>
